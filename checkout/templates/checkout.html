{% extends 'base.html' %}
{% load static %}
{% load cloudinary %}
{% load materializecss %}
{% load mathfilters %}

{% block head_js %}
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript">
    //<![CDATA[
        Stripe.publishableKey = '{{ publishable }}';
    //]]>
</script>
<script type="text/javascript" src="{% static 'js/stripe.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container">
    {% for item in cart_items %}
    <div class="row">
        <div class="col s3">
            {% cloudinary item.product.cover width=150 height=150 %}
        </div>
        <div class="col s4">
            <p>{{ item.product.album }}</p>
            <p>{{ item.product.artist }}</p>
            <p>£{{ item.product.price }}</p>
        </div>
        <div class="col s3">
            <p>
                <form action="{% url 'adjust_cart' item.id %}" method="POST" class="form-inline">
                    {% csrf_token %}
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">Quantity</div>
                            <input type="number" name="quantity" min="0" max="25" class="form-control"
                                value="{{ item.quantity }}">
                        </div>
                    </div>
                    <button type="submit" class="btn waves-effect waves-light">Amend</button>
                </form>
            </p>
        </div>
        <div class="col s2 right-align">
            <p>Subtotal:</p>
            <p>£{{ item.quantity|mul:item.product.price }}</p>
        </div>
    </div>
    {% endfor %}
    <div class="row right-align">
        <p>Total:</p>
        <p>£{{ total }}</p>
    </div>
    <div class="row">
        <form role="form" method="POST" id="payment-form" action="{% url 'checkout' %}">
            <legend>Payment Details</legend>
        
            <div id="credit-card-errors" style="display: none">
                <div class="alert-message block-message error" id="stripe-error-message"></div>
            </div>
        
            <div class="form-group col s6">
                {{ order_form | materializecss }}
            </div>
        
            <div class="form-group col s6">
                {{ payment_form | materializecss }}
            </div>
        
            {% csrf_token %}
            <div class="form-group right">
                <input type="submit" class="btn btn-primary" id="submit_payment_btn" name="commit" value="Submit Payment">
            </div>
        </form>
    </div>
</div>

{% endblock %}